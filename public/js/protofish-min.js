var ProtoFish=Class.create({initialize:function(s,e,t,i,n,a){this.id=s,this.timeout=e||"400",this.cssClass=t||"hover",this.remActive=i||!1,this.ARIA=n||!1,this.useShortKey=a||!1,this.queue=[],this.activeTimeout="",this.menuFocus=!1,this.menuCount=0,this.isParent=!1,this.shiftDown=!1,this.mDown=!1,this.ctrlDown=!1,this.altDown=!1},initObservers:function(){this.listItems.each(function(s){s.observe("mouseover",function(s,e){this.enterMenu(e),e.addClassName(this.cssClass)}.bindAsEventListener(this,s)),s.observe("mouseout",function(s,e){this.queue.push([this.leaveMenu.delay(this.timeout/1e3,this),e])}.bindAsEventListener(this,s)),0!=this.ARIA&&(s.down("a").writeAttribute("role","menuitem"),s.down("ul")&&s.down("a").writeAttribute("aria-haspopup","true"))}.bind(this)),Event.observe(document,"keydown",function(s){var e=s.keyCode,t=[9,13,27,32,37,38,39,40];-1!=t.indexOf(e)&&this.keyBoardNav(s,e,t),16==s.keyCode?this.shiftDown=!0:0!=this.useShortKey&&(77==s.keyCode&&(this.mDown=!0),17==s.keyCode&&(this.ctrlDown=!0),18==s.keyCode&&(this.altDown=!0),1==this.mDown&&1==this.ctrlDown&&1==this.altDown&&this.listItems[0].down("a").focus())}.bind(this)),Event.observe(document,"keyup",function(s){16==s.keyCode?this.shiftDown=!1:0!=this.useShortKey&&(77==s.keyCode&&(this.mDown=!1),17==s.keyCode&&(this.ctrlDown=!1),18==s.keyCode&&(this.altDown=!1))}.bind(this)),Event.observe(document,"click",function(s){var e=Event.element(s);e==$(this.id)||e.descendantOf(this.id)||1!=this.menuFocus||(this.listItems.invoke("removeClassName",this.cssClass),this.menuFocus=!1)}.bind(this)),$$("body")[0].observe("focusin",this.handleMenuFocus.bind(this)),window.addEventListener&&$$("body")[0].addEventListener("focus",this.handleMenuFocus.bind(this),!0)},handleMenuFocus:function(s){var e=Event.element(s);if(e.up("#"+this.id))if(this.menuFocus=!0,this.menuCount=this.listItems.indexOf(e.up("li")),this.isParent=!!e.next(),0==this.isParent)for(e.up().addClassName(this.cssClass);e.up("li");)e.up("li").addClassName(this.cssClass),e=e.up("li");else 1==this.isParent&&e.up().removeClassName("hover");else this.listItems.invoke("removeClassName",this.cssClass),this.menuFocus=!1},keyBoardNav:function(s,e,t){if(1==this.menuFocus){0!=t.indexOf(e)&&s.preventDefault();var i=this.listItems[this.menuCount];switch(!0){case e==Event.KEY_DOWN:if(i.up("li"))(n=i.next("li")||i.up("ul").childElements().first())&&i.removeClassName(this.cssClass);else var n=i.down("li");n&&(this.menuCount=this.listItems.indexOf(n),n.addClassName(this.cssClass),n.down("a").focus());break;case e==Event.KEY_UP:if(i.up("li")){a=i.previous("li")||i.up("ul").childElements().last();i.removeClassName(this.cssClass)}else var a=!1;a&&(this.menuCount=this.listItems.indexOf(a),a.addClassName(this.cssClass),a.down("a").focus());break;case e==Event.KEY_RIGHT:if(i.up("li"))var o=i.down("li")||!1;else(o=i.next("li"))&&i.removeClassName(this.cssClass);o&&(this.menuCount=this.listItems.indexOf(o),o.addClassName(this.cssClass),o.down("a").focus());break;case e==Event.KEY_LEFT:var h;if(i.up("li"))(h=i.up("li")||!1)&&i.removeClassName(this.cssClass);else(h=i.previous("li"))&&i.removeClassName(this.cssClass);h&&(this.menuCount=this.listItems.indexOf(h),h.addClassName(this.cssClass),h.down("a").focus());break;case e==Event.KEY_TAB:if(0==this.shiftDown){if(this.menuCount++,!(a=this.listItems[this.menuCount-1]).down("li"))for(a.removeClassName(this.cssClass);a.up("li")&&!a.next("li");)a.up("li").removeClassName(this.cssClass),a=a.up("li")}else if(1==this.shiftDown){this.menuCount--;i=this.listItems[this.menuCount];if((n=this.listItems[this.menuCount+1]).removeClassName(this.cssClass),i)for(;i.up("li")&&0==i.up("li").hasClassName(this.cssClass);)i.up("li").addClassName(this.cssClass),i=i.up("li")}break;case e==Event.KEY_ESC:for(;i.up("li");){i.removeClassName(this.cssClass);var u=i.up("li");i=i.up("li")}u&&(u.down("a").focus(),this.menuCount=this.listItems.indexOf(i));break;case 32==e:if(1==this.isParent)this.parentBehavior(i);else{var l=i.down("a").href;window.location.href=l}break;case e==Event.KEY_RETURN:1==this.isParent&&this.parentBehavior(i)}}},parentBehavior:function(s){var e=s.down("li");e&&(this.menuCount=this.listItems.indexOf(e),e.addClassName(this.cssClass),e.down("a").focus())},enterMenu:function(){for(;this.queue.length;)clearTimeout(this.queue[0][0]),this.leaveMenu(this);1==this.remActive&&("number"==typeof this.activeTimeout&&(clearTimeout(this.activeTimeout),delete this.activeTimeout),this.activeItems.invoke("removeClassName","active"))},leaveMenu:function(s){s.queue.length&&s.queue.shift()[1].removeClassName(s.cssClass);1==s.remActive&&s.activeItems.invoke("addClassName","active")}});